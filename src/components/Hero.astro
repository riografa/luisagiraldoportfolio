---
// Hero.astro
---

<section class="relative w-screen h-screen flex flex-col justify-end items-center overflow-hidden">
  <div id="model-3d-container" class="absolute inset-0 w-full h-full z-0"></div>

  <div class="relative w-full h-auto z-10 flex flex-col gap-2 p-2 text-center pb-8 text-gray-800">
    <h1 class="text-2xl lg:text-5xl font-bold">
      Luisa Fernanda Giraldo Murillo
    </h1>
    <p class="pb-8">
      Mag√≠ster Interdisciplinar en Teatro y Artes Vivas y estudiante del Doctorado en Arte y Arquitectura
    </p>
  </div>
</section>

<script type="module">
  import { initGLBScene } from '../scripts/load-glb-model.js';

  (async () => {
    const container = document.getElementById('model-3d-container');
    console.log('[Hero] üéØ Container encontrado:', !!container);
    
    if (!container) {
      console.error('[Hero] ‚ùå No se encontr√≥ el contenedor');
      return;
    }

    // Configurar contenedor
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '100vw';
    container.style.height = '100vh';
    container.style.zIndex = '0';

    console.log('[Hero] ‚úÖ Contenedor configurado');

    try {
      // ‚úÖ CR√çTICO: Usar import.meta.env.BASE_URL
      const BASE_URL = import.meta.env.BASE_URL;
      
      // Construir la ruta correcta del modelo
      // Asegurar que no haya dobles barras
      const modelPath = `${BASE_URL}models/mapa-colombia.glb`.replace(/([^:]\/)\/+/g, "$1");
      
      console.log('[Hero] üîß Configuraci√≥n:');
      console.log('[Hero]   - BASE_URL:', BASE_URL);
      console.log('[Hero]   - Model path:', modelPath);
      console.log('[Hero]   - Full URL:', window.location.origin + modelPath);
      console.log('[Hero]   - Hostname:', window.location.hostname);
      console.log('[Hero]   - Pathname:', window.location.pathname);
      
      // Verificar que el archivo existe antes de cargarlo
      console.log('[Hero] üîç Verificando archivo GLB...');
      const checkResponse = await fetch(modelPath, { method: 'HEAD' });
      
      if (!checkResponse.ok) {
        throw new Error(`Archivo no encontrado: ${modelPath} (HTTP ${checkResponse.status})`);
      }
      
      console.log('[Hero] ‚úÖ Archivo GLB verificado');
      console.log('[Hero]   - Status:', checkResponse.status);
      console.log('[Hero]   - Content-Type:', checkResponse.headers.get('content-type'));
      console.log('[Hero]   - Content-Length:', checkResponse.headers.get('content-length'), 'bytes');
      
      // Cargar la escena 3D
      console.log('[Hero] üöÄ Iniciando carga de escena 3D...');
      const scene = await initGLBScene(container, modelPath);
      
      // Guardar referencia global para debugging
      window.threeScene = scene;
      
      console.log('[Hero] ‚úÖ‚úÖ‚úÖ Escena 3D inicializada correctamente');
      console.log('[Hero] üé¨ Animaciones activas:', scene.animations?.length || 0);
      
      // Mostrar indicador de √©xito
      setTimeout(() => {
        const statusInfo = document.createElement('div');
        statusInfo.style.cssText = `
          position: fixed;
          top: 20px;
          left: 20px;
          background: rgba(0, 200, 0, 0.95);
          color: white;
          padding: 20px;
          border-radius: 10px;
          font-family: monospace;
          font-size: 13px;
          z-index: 50;
          max-width: 350px;
          line-height: 1.5;
          border-left: 4px solid #00ff00;
          box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        `;
        
        statusInfo.innerHTML = `
          <strong style="font-size: 16px;">‚úÖ Modelo 3D Cargado</strong><br><br>
          <strong>Entorno:</strong> ${BASE_URL === '/' ? 'Desarrollo' : 'Producci√≥n'}<br>
          <strong>Escala:</strong> 20x<br>
          <strong>Animaciones:</strong> ${scene.animations?.length || 0}<br>
          <strong>Controles:</strong><br>
          ‚Ä¢ Click izq + arrastrar: Rotar<br>
          ‚Ä¢ Rueda del rat√≥n: Zoom<br>
          ‚Ä¢ Click der + arrastrar: Pan<br>
          <hr style="border: 1px solid rgba(255,255,255,0.3); margin: 10px 0;">
          <small>Ruta: ${modelPath}</small>
        `;
        container.appendChild(statusInfo);
        
        // Desvanecer despu√©s de 10 segundos
        setTimeout(() => {
          statusInfo.style.transition = 'opacity 2s';
          statusInfo.style.opacity = '0';
          setTimeout(() => {
            if (container.contains(statusInfo)) {
              container.removeChild(statusInfo);
            }
          }, 2000);
        }, 10000);
      }, 1000);
      
    } catch (err) {
      console.error('[Hero] ‚ùå‚ùå‚ùå Error al inicializar escena 3D');
      console.error('[Hero] Error:', err);
      console.error('[Hero] Stack:', err.stack);
      
      const BASE_URL = import.meta.env.BASE_URL;
      const expectedPath = `${window.location.origin}${BASE_URL}models/mapa-colombia.glb`.replace(/([^:]\/)\/+/g, "$1");
      
      const errorEl = document.createElement('div');
      errorEl.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(220, 38, 38, 0.98);
        color: white;
        padding: 30px;
        border-radius: 12px;
        text-align: left;
        z-index: 100;
        max-width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.6;
        border: 3px solid #ff6b6b;
        box-shadow: 0 8px 16px rgba(0,0,0,0.5);
      `;
      
      errorEl.innerHTML = `
        <h3 style="margin: 0 0 20px 0; color: #ffcccb; font-size: 20px;">‚ùå Error Cargando Modelo 3D</h3>
        <p><strong>Error:</strong> ${err.message}</p>
        <hr style="margin: 20px 0; border: 1px solid rgba(255,255,255,0.3);">
        <p><strong>üìÇ Buscando modelo en:</strong><br>
        <code style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 3px; display: block; margin-top: 5px; word-break: break-all;">${expectedPath}</code></p>
        <hr style="margin: 20px 0; border: 1px solid rgba(255,255,255,0.3);">
        <p><strong>üîç Verificaciones necesarias:</strong></p>
        <ol style="margin: 10px 0; padding-left: 25px; line-height: 2;">
          <li>Archivo existe en: <code>/public/models/mapa-colombia.glb</code></li>
          <li>Archivo no est√° corrupto</li>
          <li>Ejecutaste <code>npm run build</code></li>
          <li>Archivo <code>.nojekyll</code> existe en <code>/public/</code></li>
          <li>GitHub Actions complet√≥ exitosamente</li>
        </ol>
        <hr style="margin: 20px 0; border: 1px solid rgba(255,255,255,0.3);">
        <p><strong>‚öôÔ∏è Configuraci√≥n actual:</strong><br>
        ‚Ä¢ BASE_URL: <code>${BASE_URL}</code><br>
        ‚Ä¢ Hostname: <code>${window.location.hostname}</code><br>
        ‚Ä¢ Pathname: <code>${window.location.pathname}</code><br>
        ‚Ä¢ Entorno: <strong>${BASE_URL === '/' ? 'DESARROLLO' : 'PRODUCCI√ìN'}</strong></p>
        <button onclick="this.parentElement.remove()" style="
          margin-top: 20px;
          padding: 12px 24px;
          background: #ff6b6b;
          border: none;
          border-radius: 6px;
          color: white;
          cursor: pointer;
          font-weight: bold;
          font-size: 14px;
        ">Cerrar</button>
      `;
      container.appendChild(errorEl);
    }
  })();

  // Limpieza al salir
  window.addEventListener('beforeunload', () => {
    const scene = window.threeScene;
    if (scene && scene.dispose) {
      scene.dispose();
    }
  });
</script>

<style>
  #model-3d-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
  }
</style>
